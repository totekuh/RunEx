using System;
using System.Text;
using System.Runtime.InteropServices;
using System.Net.Sockets;

internal static partial class NativeMethods
{
    // =====================================================================
    // Bootstrap — the only 3 P/Invoke declarations in the assembly
    // =====================================================================

    [DllImport("kernel32.dll")]
    private static extern IntPtr GetModuleHandle(string lpModuleName);

    [DllImport("kernel32.dll")]
    private static extern IntPtr LoadLibrary(string lpLibFileName);

    [DllImport("kernel32.dll")]
    private static extern IntPtr GetProcAddress(IntPtr hModule, string lpProcName);

    private static T GetDelegate<T>(string dll, string func) where T : class
    {
        IntPtr mod = GetModuleHandle(dll);
        if (mod == IntPtr.Zero) mod = LoadLibrary(dll);
        IntPtr addr = GetProcAddress(mod, func);
        return (T)(object)Marshal.GetDelegateForFunctionPointer(addr, typeof(T));
    }

    // =====================================================================
    // Delegate types
    // =====================================================================

    // --- kernel32 ---

    [UnmanagedFunctionPointer(CallingConvention.StdCall, SetLastError = true)]
    private delegate bool CloseHandle_t(IntPtr handle);

    [UnmanagedFunctionPointer(CallingConvention.StdCall, SetLastError = true)]
    private delegate UInt32 WaitForSingleObject_t(IntPtr handle, UInt32 milliseconds);

    [UnmanagedFunctionPointer(CallingConvention.StdCall, SetLastError = true)]
    private delegate int ResumeThread_t(IntPtr hThread);

    [UnmanagedFunctionPointer(CallingConvention.StdCall, SetLastError = true, CharSet = CharSet.Unicode)]
    private delegate bool CreateProcess_t(string lpApplicationName, string lpCommandLine, IntPtr lpProcessAttributes, IntPtr lpThreadAttributes, bool bInheritHandles, uint dwCreationFlags, IntPtr lpEnvironment, string lpCurrentDirectory, [In] ref STARTUPINFO lpStartupInfo, out ProcessInformation lpProcessInformation);

    [UnmanagedFunctionPointer(CallingConvention.StdCall, SetLastError = true)]
    private delegate bool CreatePipe_t(out IntPtr hReadPipe, out IntPtr hWritePipe, ref SECURITY_ATTRIBUTES lpPipeAttributes, uint nSize);

    [UnmanagedFunctionPointer(CallingConvention.StdCall)]
    private delegate bool SetNamedPipeHandleState_t(IntPtr hNamedPipe, ref UInt32 lpMode, IntPtr lpMaxCollectionCount, IntPtr lpCollectDataTimeout);

    [UnmanagedFunctionPointer(CallingConvention.StdCall, SetLastError = true)]
    private delegate bool ReadFile_t(IntPtr hFile, [Out] byte[] lpBuffer, uint nNumberOfBytesToRead, out uint lpNumberOfBytesRead, IntPtr lpOverlapped);

    [UnmanagedFunctionPointer(CallingConvention.StdCall, SetLastError = true)]
    [return: MarshalAs(UnmanagedType.Bool)]
    private delegate bool DuplicateHandle_t(IntPtr hSourceProcessHandle, IntPtr hSourceHandle, IntPtr hTargetProcessHandle, out IntPtr lpTargetHandle, uint dwDesiredAccess, [MarshalAs(UnmanagedType.Bool)] bool bInheritHandle, uint dwOptions);

    [UnmanagedFunctionPointer(CallingConvention.StdCall, SetLastError = true)]
    private delegate IntPtr GetStdHandle_t(uint nStdHandle);

    [UnmanagedFunctionPointer(CallingConvention.StdCall, SetLastError = true)]
    [return: MarshalAs(UnmanagedType.Bool)]
    private delegate bool GetExitCodeProcess_t(IntPtr hProcess, out uint lpExitCode);

    // --- advapi32 ---

    [UnmanagedFunctionPointer(CallingConvention.StdCall, SetLastError = true)]
    private delegate bool ImpersonateLoggedOnUser_t(IntPtr hToken);

    [UnmanagedFunctionPointer(CallingConvention.StdCall, SetLastError = true)]
    private delegate bool SetThreadToken_t(ref IntPtr pHandle, IntPtr hToken);

    [UnmanagedFunctionPointer(CallingConvention.StdCall, SetLastError = true)]
    private delegate bool RevertToSelf_t();

    [UnmanagedFunctionPointer(CallingConvention.StdCall, SetLastError = true)]
    [return: MarshalAs(UnmanagedType.Bool)]
    private delegate bool LogonUser_t([MarshalAs(UnmanagedType.LPStr)] string pszUserName, [MarshalAs(UnmanagedType.LPStr)] string pszDomain, [MarshalAs(UnmanagedType.LPStr)] string pszPassword, int dwLogonType, int dwLogonProvider, ref IntPtr phToken);

    [UnmanagedFunctionPointer(CallingConvention.StdCall, SetLastError = true)]
    private delegate bool DuplicateTokenEx_t(IntPtr ExistingTokenHandle, uint dwDesiredAccess, IntPtr lpThreadAttributes, SECURITY_IMPERSONATION_LEVEL ImpersonationLevel, int TokenType, ref IntPtr DuplicateTokenHandle);

    [UnmanagedFunctionPointer(CallingConvention.StdCall, SetLastError = true)]
    [return: MarshalAs(UnmanagedType.Bool)]
    private delegate bool OpenProcessToken_t(IntPtr ProcessHandle, uint DesiredAccess, out IntPtr TokenHandle);

    [UnmanagedFunctionPointer(CallingConvention.StdCall, SetLastError = true, CharSet = CharSet.Unicode)]
    private delegate bool CreateProcessWithLogonW_t(String userName, String domain, String password, UInt32 logonFlags, String applicationName, String commandLine, uint creationFlags, UInt32 environment, String currentDirectory, ref STARTUPINFO startupInfo, out ProcessInformation processInformation);

    [UnmanagedFunctionPointer(CallingConvention.StdCall, SetLastError = true, CharSet = CharSet.Unicode)]
    private delegate bool CreateProcessAsUser_t(IntPtr hToken, string lpApplicationName, string lpCommandLine, IntPtr lpProcessAttributes, IntPtr lpThreadAttributes, bool bInheritHandles, uint dwCreationFlags, IntPtr lpEnvironment, string lpCurrentDirectory, ref STARTUPINFO lpStartupInfo, out ProcessInformation lpProcessInformation);

    [UnmanagedFunctionPointer(CallingConvention.StdCall, SetLastError = true, CharSet = CharSet.Unicode)]
    private delegate bool CreateProcessWithTokenW_t(IntPtr hToken, uint dwLogonFlags, string lpApplicationName, string lpCommandLine, uint dwCreationFlags, IntPtr lpEnvironment, string lpCurrentDirectory, [In] ref STARTUPINFO lpStartupInfo, out ProcessInformation lpProcessInformation);

    [UnmanagedFunctionPointer(CallingConvention.StdCall, SetLastError = true)]
    private delegate uint SetSecurityInfo_t(IntPtr handle, SE_OBJECT_TYPE ObjectType, uint SecurityInfo, IntPtr psidOwner, IntPtr psidGroup, IntPtr pDacl, IntPtr pSacl);

    [UnmanagedFunctionPointer(CallingConvention.StdCall)]
    private delegate IntPtr FreeSid_t(IntPtr pSid);

    [UnmanagedFunctionPointer(CallingConvention.StdCall, SetLastError = true)]
    [return: MarshalAs(UnmanagedType.Bool)]
    private delegate bool GetSecurityDescriptorDacl_t(IntPtr pSecurityDescriptor, [MarshalAs(UnmanagedType.Bool)] out bool bDaclPresent, ref IntPtr pDacl, [MarshalAs(UnmanagedType.Bool)] out bool bDaclDefaulted);

    [UnmanagedFunctionPointer(CallingConvention.StdCall, SetLastError = true)]
    [return: MarshalAs(UnmanagedType.Bool)]
    private delegate bool GetAclInformation_t(IntPtr pAcl, ref ACL_SIZE_INFORMATION pAclInformation, uint nAclInformationLength, ACL_INFORMATION_CLASS dwAclInformationClass);

    [UnmanagedFunctionPointer(CallingConvention.StdCall, SetLastError = true)]
    private delegate bool InitializeSecurityDescriptor_t(IntPtr SecurityDescriptor, uint dwRevision);

    [UnmanagedFunctionPointer(CallingConvention.StdCall, SetLastError = true)]
    private delegate int GetLengthSid_t(IntPtr pSID);

    [UnmanagedFunctionPointer(CallingConvention.StdCall, SetLastError = true)]
    private delegate bool InitializeAcl_t(IntPtr pAcl, uint nAclLength, uint dwAclRevision);

    [UnmanagedFunctionPointer(CallingConvention.StdCall, SetLastError = true)]
    private delegate bool GetAce_t(IntPtr aclPtr, int aceIndex, out IntPtr acePtr);

    [UnmanagedFunctionPointer(CallingConvention.StdCall, SetLastError = true)]
    private delegate bool AddAce_t(IntPtr pAcl, uint dwAceRevision, uint dwStartingAceIndex, IntPtr pAceList, uint nAceListLength);

    [UnmanagedFunctionPointer(CallingConvention.StdCall, SetLastError = true)]
    private delegate bool SetSecurityDescriptorDacl_t(IntPtr sd, bool daclPresent, IntPtr dacl, bool daclDefaulted);

    [UnmanagedFunctionPointer(CallingConvention.StdCall, SetLastError = true)]
    private delegate bool CopySid_t(uint nDestinationSidLength, IntPtr pDestinationSid, IntPtr pSourceSid);

    [UnmanagedFunctionPointer(CallingConvention.StdCall, SetLastError = true, CharSet = CharSet.Unicode)]
    [return: MarshalAs(UnmanagedType.Bool)]
    private delegate bool LookupAccountName_t(string lpSystemName, string lpAccountName, [MarshalAs(UnmanagedType.LPArray)] byte[] Sid, ref uint cbSid, StringBuilder ReferencedDomainName, ref uint cchReferencedDomainName, out SID_NAME_USE peUse);

    [UnmanagedFunctionPointer(CallingConvention.StdCall, SetLastError = true)]
    private delegate bool GetTokenInformation_uint_t(IntPtr TokenHandle, TOKEN_INFORMATION_CLASS TokenInformationClass, IntPtr TokenInformation, uint TokenInformationLength, out uint ReturnLength);

    [UnmanagedFunctionPointer(CallingConvention.StdCall, SetLastError = true)]
    private delegate bool GetTokenInformation_int_t(IntPtr TokenHandle, TOKEN_INFORMATION_CLASS TokenInformationClass, IntPtr TokenInformation, int TokenInformationLength, out int ReturnLength);

    [UnmanagedFunctionPointer(CallingConvention.StdCall, SetLastError = true, CharSet = CharSet.Unicode)]
    [return: MarshalAs(UnmanagedType.Bool)]
    private delegate bool LookupPrivilegeName_t(string lpSystemName, IntPtr lpLuid, StringBuilder lpName, ref int cchName);

    [UnmanagedFunctionPointer(CallingConvention.StdCall, SetLastError = true)]
    private delegate bool AllocateAndInitializeSid_t(IntPtr pIdentifierAuthority, byte nSubAuthorityCount, int dwSubAuthority0, int dwSubAuthority1, int dwSubAuthority2, int dwSubAuthority3, int dwSubAuthority4, int dwSubAuthority5, int dwSubAuthority6, int dwSubAuthority7, out IntPtr pSid);

    [UnmanagedFunctionPointer(CallingConvention.StdCall, SetLastError = true)]
    private delegate bool SetTokenInformation_t(IntPtr TokenHandle, TOKEN_INFORMATION_CLASS TokenInformationClass, IntPtr TokenInformation, int TokenInformationLength);

    [UnmanagedFunctionPointer(CallingConvention.StdCall, SetLastError = true)]
    private delegate IntPtr GetSidSubAuthority_t(IntPtr sid, UInt32 subAuthorityIndex);

    [UnmanagedFunctionPointer(CallingConvention.StdCall, SetLastError = true)]
    private delegate IntPtr GetSidSubAuthorityCount_t(IntPtr sid);

    [UnmanagedFunctionPointer(CallingConvention.StdCall, SetLastError = true)]
    private delegate bool AdjustTokenPrivileges_t(IntPtr tokenhandle, bool disableprivs, [MarshalAs(UnmanagedType.Struct)] ref TOKEN_PRIVILEGES_2 Newstate, int bufferlength, int PreivousState, int Returnlength);

    [UnmanagedFunctionPointer(CallingConvention.StdCall, SetLastError = true)]
    private delegate int LookupPrivilegeValue_t(string lpsystemname, string lpname, [MarshalAs(UnmanagedType.Struct)] ref LUID lpLuid);

    // --- user32 ---

    [UnmanagedFunctionPointer(CallingConvention.StdCall, SetLastError = true)]
    private delegate IntPtr GetProcessWindowStation_t();

    [UnmanagedFunctionPointer(CallingConvention.StdCall, SetLastError = true)]
    private delegate bool GetUserObjectInformation_t(IntPtr hObj, int nIndex, [Out] byte[] pvInfo, uint nLength, out uint lpnLengthNeeded);

    [UnmanagedFunctionPointer(CallingConvention.StdCall, SetLastError = true, CharSet = CharSet.Unicode)]
    private delegate IntPtr OpenWindowStation_t([MarshalAs(UnmanagedType.LPTStr)] string lpszWinSta, [MarshalAs(UnmanagedType.Bool)] bool fInherit, ACCESS_MASK dwDesiredAccess);

    [UnmanagedFunctionPointer(CallingConvention.StdCall)]
    private delegate IntPtr OpenDesktop_t(string lpszDesktop, uint dwFlags, bool fInherit, ACCESS_MASK dwDesiredAccess);

    [UnmanagedFunctionPointer(CallingConvention.StdCall, SetLastError = true)]
    [return: MarshalAs(UnmanagedType.Bool)]
    private delegate bool CloseWindowStation_t(IntPtr hWinsta);

    [UnmanagedFunctionPointer(CallingConvention.StdCall, SetLastError = true)]
    private delegate bool CloseDesktop_t(IntPtr hDesktop);

    [UnmanagedFunctionPointer(CallingConvention.StdCall, SetLastError = true)]
    private delegate bool SetProcessWindowStation_t(IntPtr hWinSta);

    [UnmanagedFunctionPointer(CallingConvention.StdCall, SetLastError = true)]
    private delegate bool GetUserObjectSecurity_t(IntPtr hObj, ref SECURITY_INFORMATION pSIRequested, IntPtr pSID, uint nLength, out uint lpnLengthNeeded);

    [UnmanagedFunctionPointer(CallingConvention.StdCall, SetLastError = true)]
    private delegate bool SetUserObjectSecurity_t(IntPtr hObj, ref SECURITY_INFORMATION pSIRequested, IntPtr pSD);

    // --- userenv ---

    [UnmanagedFunctionPointer(CallingConvention.StdCall, SetLastError = true)]
    private delegate bool CreateEnvironmentBlock_t(out IntPtr lpEnvironment, IntPtr hToken, bool bInherit);

    [UnmanagedFunctionPointer(CallingConvention.StdCall, SetLastError = true)]
    private delegate bool DestroyEnvironmentBlock_t(IntPtr lpEnvironment);

    [UnmanagedFunctionPointer(CallingConvention.StdCall, SetLastError = true, CharSet = CharSet.Unicode)]
    private delegate bool GetUserProfileDirectory_t(IntPtr hToken, StringBuilder path, ref int dwSize);

    [UnmanagedFunctionPointer(CallingConvention.StdCall, SetLastError = true, CharSet = CharSet.Unicode)]
    private delegate bool LoadUserProfile_t(IntPtr hToken, ref PROFILEINFO lpProfileInfo);

    [UnmanagedFunctionPointer(CallingConvention.StdCall, SetLastError = true)]
    private delegate bool UnloadUserProfile_t(IntPtr hToken, IntPtr hProfile);

    // --- ws2_32 ---

    [UnmanagedFunctionPointer(CallingConvention.StdCall, SetLastError = true, CharSet = CharSet.Ansi)]
    private delegate IntPtr WSASocket_t([In] AddressFamily addressFamily, [In] SocketType socketType, [In] ProtocolType protocolType, [In] IntPtr protocolInfo, [In] uint group, [In] int flags);

    [UnmanagedFunctionPointer(CallingConvention.StdCall, SetLastError = true)]
    private delegate int connect_t(IntPtr s, ref SOCKADDR_IN addr, int addrsize);

    [UnmanagedFunctionPointer(CallingConvention.StdCall, SetLastError = true)]
    private delegate ushort htons_t(ushort hostshort);

    [UnmanagedFunctionPointer(CallingConvention.StdCall)]
    private delegate Int32 WSAGetLastError_t();

    [UnmanagedFunctionPointer(CallingConvention.StdCall, SetLastError = true)]
    private delegate Int32 WSAStartup_t(Int16 wVersionRequested, out WSAData wsaData);

    [UnmanagedFunctionPointer(CallingConvention.StdCall, SetLastError = true)]
    private delegate int closesocket_t(IntPtr s);

    // =====================================================================
    // Cached delegate fields
    // =====================================================================

    // kernel32
    private static CloseHandle_t _CloseHandle;
    private static WaitForSingleObject_t _WaitForSingleObject;
    private static ResumeThread_t _ResumeThread;
    private static CreateProcess_t _CreateProcess;
    private static CreatePipe_t _CreatePipe;
    private static SetNamedPipeHandleState_t _SetNamedPipeHandleState;
    private static ReadFile_t _ReadFile;
    private static DuplicateHandle_t _DuplicateHandle;
    private static GetStdHandle_t _GetStdHandle;
    private static GetExitCodeProcess_t _GetExitCodeProcess;

    // advapi32
    private static ImpersonateLoggedOnUser_t _ImpersonateLoggedOnUser;
    private static SetThreadToken_t _SetThreadToken;
    private static RevertToSelf_t _RevertToSelf;
    private static LogonUser_t _LogonUser;
    private static DuplicateTokenEx_t _DuplicateTokenEx;
    private static OpenProcessToken_t _OpenProcessToken;
    private static CreateProcessWithLogonW_t _CreateProcessWithLogonW;
    private static CreateProcessAsUser_t _CreateProcessAsUser;
    private static CreateProcessWithTokenW_t _CreateProcessWithTokenW;
    private static SetSecurityInfo_t _SetSecurityInfo;
    private static FreeSid_t _FreeSid;
    private static GetSecurityDescriptorDacl_t _GetSecurityDescriptorDacl;
    private static GetAclInformation_t _GetAclInformation;
    private static InitializeSecurityDescriptor_t _InitializeSecurityDescriptor;
    private static GetLengthSid_t _GetLengthSid;
    private static InitializeAcl_t _InitializeAcl;
    private static GetAce_t _GetAce;
    private static AddAce_t _AddAce;
    private static SetSecurityDescriptorDacl_t _SetSecurityDescriptorDacl;
    private static CopySid_t _CopySid;
    private static LookupAccountName_t _LookupAccountName;
    private static GetTokenInformation_uint_t _GetTokenInformation_uint;
    private static GetTokenInformation_int_t _GetTokenInformation_int;
    private static LookupPrivilegeName_t _LookupPrivilegeName;
    private static AllocateAndInitializeSid_t _AllocateAndInitializeSid;
    private static SetTokenInformation_t _SetTokenInformation;
    private static GetSidSubAuthority_t _GetSidSubAuthority;
    private static GetSidSubAuthorityCount_t _GetSidSubAuthorityCount;
    private static AdjustTokenPrivileges_t _AdjustTokenPrivileges;
    private static LookupPrivilegeValue_t _LookupPrivilegeValue;

    // user32
    private static GetProcessWindowStation_t _GetProcessWindowStation;
    private static GetUserObjectInformation_t _GetUserObjectInformation;
    private static OpenWindowStation_t _OpenWindowStation;
    private static OpenDesktop_t _OpenDesktop;
    private static CloseWindowStation_t _CloseWindowStation;
    private static CloseDesktop_t _CloseDesktop;
    private static SetProcessWindowStation_t _SetProcessWindowStation;
    private static GetUserObjectSecurity_t _GetUserObjectSecurity;
    private static SetUserObjectSecurity_t _SetUserObjectSecurity;

    // userenv
    private static CreateEnvironmentBlock_t _CreateEnvironmentBlock;
    private static DestroyEnvironmentBlock_t _DestroyEnvironmentBlock;
    private static GetUserProfileDirectory_t _GetUserProfileDirectory;
    private static LoadUserProfile_t _LoadUserProfile;
    private static UnloadUserProfile_t _UnloadUserProfile;

    // ws2_32
    private static WSASocket_t _WSASocket;
    private static connect_t _connect;
    private static htons_t _htons;
    private static WSAGetLastError_t _WSAGetLastError;
    private static WSAStartup_t _WSAStartup;
    private static closesocket_t _closesocket;

    // =====================================================================
    // Wrapper methods — same signatures as original P/Invoke declarations
    // =====================================================================

    // --- kernel32 ---

    internal static bool CloseHandle(IntPtr handle) {
        if (_CloseHandle == null) _CloseHandle = GetDelegate<CloseHandle_t>("kernel32.dll", "CloseHandle");
        return _CloseHandle(handle);
    }

    internal static UInt32 WaitForSingleObject(IntPtr handle, UInt32 milliseconds) {
        if (_WaitForSingleObject == null) _WaitForSingleObject = GetDelegate<WaitForSingleObject_t>("kernel32.dll", "WaitForSingleObject");
        return _WaitForSingleObject(handle, milliseconds);
    }

    internal static int ResumeThread(IntPtr hThread) {
        if (_ResumeThread == null) _ResumeThread = GetDelegate<ResumeThread_t>("kernel32.dll", "ResumeThread");
        return _ResumeThread(hThread);
    }

    internal static bool CreateProcess(string lpApplicationName, string lpCommandLine, IntPtr lpProcessAttributes, IntPtr lpThreadAttributes, bool bInheritHandles, uint dwCreationFlags, IntPtr lpEnvironment, string lpCurrentDirectory, ref STARTUPINFO lpStartupInfo, out ProcessInformation lpProcessInformation) {
        if (_CreateProcess == null) _CreateProcess = GetDelegate<CreateProcess_t>("kernel32.dll", "CreateProcessW");
        return _CreateProcess(lpApplicationName, lpCommandLine, lpProcessAttributes, lpThreadAttributes, bInheritHandles, dwCreationFlags, lpEnvironment, lpCurrentDirectory, ref lpStartupInfo, out lpProcessInformation);
    }

    internal static bool CreatePipe(out IntPtr hReadPipe, out IntPtr hWritePipe, ref SECURITY_ATTRIBUTES lpPipeAttributes, uint nSize) {
        if (_CreatePipe == null) _CreatePipe = GetDelegate<CreatePipe_t>("kernel32.dll", "CreatePipe");
        return _CreatePipe(out hReadPipe, out hWritePipe, ref lpPipeAttributes, nSize);
    }

    internal static bool SetNamedPipeHandleState(IntPtr hNamedPipe, ref UInt32 lpMode, IntPtr lpMaxCollectionCount, IntPtr lpCollectDataTimeout) {
        if (_SetNamedPipeHandleState == null) _SetNamedPipeHandleState = GetDelegate<SetNamedPipeHandleState_t>("kernel32.dll", "SetNamedPipeHandleState");
        return _SetNamedPipeHandleState(hNamedPipe, ref lpMode, lpMaxCollectionCount, lpCollectDataTimeout);
    }

    internal static bool ReadFile(IntPtr hFile, byte[] lpBuffer, uint nNumberOfBytesToRead, out uint lpNumberOfBytesRead, IntPtr lpOverlapped) {
        if (_ReadFile == null) _ReadFile = GetDelegate<ReadFile_t>("kernel32.dll", "ReadFile");
        return _ReadFile(hFile, lpBuffer, nNumberOfBytesToRead, out lpNumberOfBytesRead, lpOverlapped);
    }

    internal static bool DuplicateHandle(IntPtr hSourceProcessHandle, IntPtr hSourceHandle, IntPtr hTargetProcessHandle, out IntPtr lpTargetHandle, uint dwDesiredAccess, bool bInheritHandle, uint dwOptions) {
        if (_DuplicateHandle == null) _DuplicateHandle = GetDelegate<DuplicateHandle_t>("kernel32.dll", "DuplicateHandle");
        return _DuplicateHandle(hSourceProcessHandle, hSourceHandle, hTargetProcessHandle, out lpTargetHandle, dwDesiredAccess, bInheritHandle, dwOptions);
    }

    internal static IntPtr GetStdHandle(uint nStdHandle) {
        if (_GetStdHandle == null) _GetStdHandle = GetDelegate<GetStdHandle_t>("kernel32.dll", "GetStdHandle");
        return _GetStdHandle(nStdHandle);
    }

    internal static bool GetExitCodeProcess(IntPtr hProcess, out uint lpExitCode) {
        if (_GetExitCodeProcess == null) _GetExitCodeProcess = GetDelegate<GetExitCodeProcess_t>("kernel32.dll", "GetExitCodeProcess");
        return _GetExitCodeProcess(hProcess, out lpExitCode);
    }

    // --- advapi32 ---

    internal static bool ImpersonateLoggedOnUser(IntPtr hToken) {
        if (_ImpersonateLoggedOnUser == null) _ImpersonateLoggedOnUser = GetDelegate<ImpersonateLoggedOnUser_t>("advapi32.dll", "ImpersonateLoggedOnUser");
        return _ImpersonateLoggedOnUser(hToken);
    }

    internal static bool SetThreadToken(ref IntPtr pHandle, IntPtr hToken) {
        if (_SetThreadToken == null) _SetThreadToken = GetDelegate<SetThreadToken_t>("advapi32.dll", "SetThreadToken");
        return _SetThreadToken(ref pHandle, hToken);
    }

    internal static bool RevertToSelf() {
        if (_RevertToSelf == null) _RevertToSelf = GetDelegate<RevertToSelf_t>("advapi32.dll", "RevertToSelf");
        return _RevertToSelf();
    }

    internal static bool LogonUser(string pszUserName, string pszDomain, string pszPassword, int dwLogonType, int dwLogonProvider, ref IntPtr phToken) {
        if (_LogonUser == null) _LogonUser = GetDelegate<LogonUser_t>("advapi32.dll", "LogonUserA");
        return _LogonUser(pszUserName, pszDomain, pszPassword, dwLogonType, dwLogonProvider, ref phToken);
    }

    internal static bool DuplicateTokenEx(IntPtr ExistingTokenHandle, uint dwDesiredAccess, IntPtr lpThreadAttributes, SECURITY_IMPERSONATION_LEVEL ImpersonationLevel, int TokenType, ref IntPtr DuplicateTokenHandle) {
        if (_DuplicateTokenEx == null) _DuplicateTokenEx = GetDelegate<DuplicateTokenEx_t>("advapi32.dll", "DuplicateTokenEx");
        return _DuplicateTokenEx(ExistingTokenHandle, dwDesiredAccess, lpThreadAttributes, ImpersonationLevel, TokenType, ref DuplicateTokenHandle);
    }

    internal static bool OpenProcessToken(IntPtr ProcessHandle, uint DesiredAccess, out IntPtr TokenHandle) {
        if (_OpenProcessToken == null) _OpenProcessToken = GetDelegate<OpenProcessToken_t>("advapi32.dll", "OpenProcessToken");
        return _OpenProcessToken(ProcessHandle, DesiredAccess, out TokenHandle);
    }

    internal static bool CreateProcessWithLogonW(String userName, String domain, String password, UInt32 logonFlags, String applicationName, String commandLine, uint creationFlags, UInt32 environment, String currentDirectory, ref STARTUPINFO startupInfo, out ProcessInformation processInformation) {
        if (_CreateProcessWithLogonW == null) _CreateProcessWithLogonW = GetDelegate<CreateProcessWithLogonW_t>("advapi32.dll", "CreateProcessWithLogonW");
        return _CreateProcessWithLogonW(userName, domain, password, logonFlags, applicationName, commandLine, creationFlags, environment, currentDirectory, ref startupInfo, out processInformation);
    }

    internal static bool CreateProcessAsUser(IntPtr hToken, string lpApplicationName, string lpCommandLine, IntPtr lpProcessAttributes, IntPtr lpThreadAttributes, bool bInheritHandles, uint dwCreationFlags, IntPtr lpEnvironment, string lpCurrentDirectory, ref STARTUPINFO lpStartupInfo, out ProcessInformation lpProcessInformation) {
        if (_CreateProcessAsUser == null) _CreateProcessAsUser = GetDelegate<CreateProcessAsUser_t>("advapi32.dll", "CreateProcessAsUserW");
        return _CreateProcessAsUser(hToken, lpApplicationName, lpCommandLine, lpProcessAttributes, lpThreadAttributes, bInheritHandles, dwCreationFlags, lpEnvironment, lpCurrentDirectory, ref lpStartupInfo, out lpProcessInformation);
    }

    internal static bool CreateProcessWithTokenW(IntPtr hToken, uint dwLogonFlags, string lpApplicationName, string lpCommandLine, uint dwCreationFlags, IntPtr lpEnvironment, string lpCurrentDirectory, ref STARTUPINFO lpStartupInfo, out ProcessInformation lpProcessInformation) {
        if (_CreateProcessWithTokenW == null) _CreateProcessWithTokenW = GetDelegate<CreateProcessWithTokenW_t>("advapi32.dll", "CreateProcessWithTokenW");
        return _CreateProcessWithTokenW(hToken, dwLogonFlags, lpApplicationName, lpCommandLine, dwCreationFlags, lpEnvironment, lpCurrentDirectory, ref lpStartupInfo, out lpProcessInformation);
    }

    internal static uint SetSecurityInfo(IntPtr handle, SE_OBJECT_TYPE ObjectType, uint SecurityInfo, IntPtr psidOwner, IntPtr psidGroup, IntPtr pDacl, IntPtr pSacl) {
        if (_SetSecurityInfo == null) _SetSecurityInfo = GetDelegate<SetSecurityInfo_t>("advapi32.dll", "SetSecurityInfo");
        return _SetSecurityInfo(handle, ObjectType, SecurityInfo, psidOwner, psidGroup, pDacl, pSacl);
    }

    internal static IntPtr FreeSid(IntPtr pSid) {
        if (_FreeSid == null) _FreeSid = GetDelegate<FreeSid_t>("advapi32.dll", "FreeSid");
        return _FreeSid(pSid);
    }

    internal static bool GetSecurityDescriptorDacl(IntPtr pSecurityDescriptor, out bool bDaclPresent, ref IntPtr pDacl, out bool bDaclDefaulted) {
        if (_GetSecurityDescriptorDacl == null) _GetSecurityDescriptorDacl = GetDelegate<GetSecurityDescriptorDacl_t>("advapi32.dll", "GetSecurityDescriptorDacl");
        return _GetSecurityDescriptorDacl(pSecurityDescriptor, out bDaclPresent, ref pDacl, out bDaclDefaulted);
    }

    internal static bool GetAclInformation(IntPtr pAcl, ref ACL_SIZE_INFORMATION pAclInformation, uint nAclInformationLength, ACL_INFORMATION_CLASS dwAclInformationClass) {
        if (_GetAclInformation == null) _GetAclInformation = GetDelegate<GetAclInformation_t>("advapi32.dll", "GetAclInformation");
        return _GetAclInformation(pAcl, ref pAclInformation, nAclInformationLength, dwAclInformationClass);
    }

    internal static bool InitializeSecurityDescriptor(IntPtr SecurityDescriptor, uint dwRevision) {
        if (_InitializeSecurityDescriptor == null) _InitializeSecurityDescriptor = GetDelegate<InitializeSecurityDescriptor_t>("advapi32.dll", "InitializeSecurityDescriptor");
        return _InitializeSecurityDescriptor(SecurityDescriptor, dwRevision);
    }

    internal static int GetLengthSid(IntPtr pSID) {
        if (_GetLengthSid == null) _GetLengthSid = GetDelegate<GetLengthSid_t>("advapi32.dll", "GetLengthSid");
        return _GetLengthSid(pSID);
    }

    internal static bool InitializeAcl(IntPtr pAcl, uint nAclLength, uint dwAclRevision) {
        if (_InitializeAcl == null) _InitializeAcl = GetDelegate<InitializeAcl_t>("advapi32.dll", "InitializeAcl");
        return _InitializeAcl(pAcl, nAclLength, dwAclRevision);
    }

    internal static bool GetAce(IntPtr aclPtr, int aceIndex, out IntPtr acePtr) {
        if (_GetAce == null) _GetAce = GetDelegate<GetAce_t>("advapi32.dll", "GetAce");
        return _GetAce(aclPtr, aceIndex, out acePtr);
    }

    internal static bool AddAce(IntPtr pAcl, uint dwAceRevision, uint dwStartingAceIndex, IntPtr pAceList, uint nAceListLength) {
        if (_AddAce == null) _AddAce = GetDelegate<AddAce_t>("advapi32.dll", "AddAce");
        return _AddAce(pAcl, dwAceRevision, dwStartingAceIndex, pAceList, nAceListLength);
    }

    internal static bool SetSecurityDescriptorDacl(IntPtr sd, bool daclPresent, IntPtr dacl, bool daclDefaulted) {
        if (_SetSecurityDescriptorDacl == null) _SetSecurityDescriptorDacl = GetDelegate<SetSecurityDescriptorDacl_t>("advapi32.dll", "SetSecurityDescriptorDacl");
        return _SetSecurityDescriptorDacl(sd, daclPresent, dacl, daclDefaulted);
    }

    internal static bool CopySid(uint nDestinationSidLength, IntPtr pDestinationSid, IntPtr pSourceSid) {
        if (_CopySid == null) _CopySid = GetDelegate<CopySid_t>("advapi32.dll", "CopySid");
        return _CopySid(nDestinationSidLength, pDestinationSid, pSourceSid);
    }

    internal static bool LookupAccountName(string lpSystemName, string lpAccountName, byte[] Sid, ref uint cbSid, StringBuilder ReferencedDomainName, ref uint cchReferencedDomainName, out SID_NAME_USE peUse) {
        if (_LookupAccountName == null) _LookupAccountName = GetDelegate<LookupAccountName_t>("advapi32.dll", "LookupAccountNameW");
        return _LookupAccountName(lpSystemName, lpAccountName, Sid, ref cbSid, ReferencedDomainName, ref cchReferencedDomainName, out peUse);
    }

    internal static bool GetTokenInformation(IntPtr TokenHandle, TOKEN_INFORMATION_CLASS TokenInformationClass, IntPtr TokenInformation, uint TokenInformationLength, out uint ReturnLength) {
        if (_GetTokenInformation_uint == null) _GetTokenInformation_uint = GetDelegate<GetTokenInformation_uint_t>("advapi32.dll", "GetTokenInformation");
        return _GetTokenInformation_uint(TokenHandle, TokenInformationClass, TokenInformation, TokenInformationLength, out ReturnLength);
    }

    internal static bool GetTokenInformation(IntPtr TokenHandle, TOKEN_INFORMATION_CLASS TokenInformationClass, IntPtr TokenInformation, int TokenInformationLength, out int ReturnLength) {
        if (_GetTokenInformation_int == null) _GetTokenInformation_int = GetDelegate<GetTokenInformation_int_t>("advapi32.dll", "GetTokenInformation");
        return _GetTokenInformation_int(TokenHandle, TokenInformationClass, TokenInformation, TokenInformationLength, out ReturnLength);
    }

    internal static bool LookupPrivilegeName(string lpSystemName, IntPtr lpLuid, StringBuilder lpName, ref int cchName) {
        if (_LookupPrivilegeName == null) _LookupPrivilegeName = GetDelegate<LookupPrivilegeName_t>("advapi32.dll", "LookupPrivilegeNameW");
        return _LookupPrivilegeName(lpSystemName, lpLuid, lpName, ref cchName);
    }

    internal static bool AllocateAndInitializeSid(IntPtr pIdentifierAuthority, byte nSubAuthorityCount, int dwSubAuthority0, int dwSubAuthority1, int dwSubAuthority2, int dwSubAuthority3, int dwSubAuthority4, int dwSubAuthority5, int dwSubAuthority6, int dwSubAuthority7, out IntPtr pSid) {
        if (_AllocateAndInitializeSid == null) _AllocateAndInitializeSid = GetDelegate<AllocateAndInitializeSid_t>("advapi32.dll", "AllocateAndInitializeSid");
        return _AllocateAndInitializeSid(pIdentifierAuthority, nSubAuthorityCount, dwSubAuthority0, dwSubAuthority1, dwSubAuthority2, dwSubAuthority3, dwSubAuthority4, dwSubAuthority5, dwSubAuthority6, dwSubAuthority7, out pSid);
    }

    internal static bool SetTokenInformation(IntPtr TokenHandle, TOKEN_INFORMATION_CLASS TokenInformationClass, IntPtr TokenInformation, int TokenInformationLength) {
        if (_SetTokenInformation == null) _SetTokenInformation = GetDelegate<SetTokenInformation_t>("advapi32.dll", "SetTokenInformation");
        return _SetTokenInformation(TokenHandle, TokenInformationClass, TokenInformation, TokenInformationLength);
    }

    internal static IntPtr GetSidSubAuthority(IntPtr sid, UInt32 subAuthorityIndex) {
        if (_GetSidSubAuthority == null) _GetSidSubAuthority = GetDelegate<GetSidSubAuthority_t>("advapi32.dll", "GetSidSubAuthority");
        return _GetSidSubAuthority(sid, subAuthorityIndex);
    }

    internal static IntPtr GetSidSubAuthorityCount(IntPtr sid) {
        if (_GetSidSubAuthorityCount == null) _GetSidSubAuthorityCount = GetDelegate<GetSidSubAuthorityCount_t>("advapi32.dll", "GetSidSubAuthorityCount");
        return _GetSidSubAuthorityCount(sid);
    }

    internal static bool AdjustTokenPrivileges(IntPtr tokenhandle, bool disableprivs, ref TOKEN_PRIVILEGES_2 Newstate, int bufferlength, int PreivousState, int Returnlength) {
        if (_AdjustTokenPrivileges == null) _AdjustTokenPrivileges = GetDelegate<AdjustTokenPrivileges_t>("advapi32.dll", "AdjustTokenPrivileges");
        return _AdjustTokenPrivileges(tokenhandle, disableprivs, ref Newstate, bufferlength, PreivousState, Returnlength);
    }

    internal static int LookupPrivilegeValue(string lpsystemname, string lpname, ref LUID lpLuid) {
        if (_LookupPrivilegeValue == null) _LookupPrivilegeValue = GetDelegate<LookupPrivilegeValue_t>("advapi32.dll", "LookupPrivilegeValueA");
        return _LookupPrivilegeValue(lpsystemname, lpname, ref lpLuid);
    }

    // --- user32 ---

    internal static IntPtr GetProcessWindowStation() {
        if (_GetProcessWindowStation == null) _GetProcessWindowStation = GetDelegate<GetProcessWindowStation_t>("user32.dll", "GetProcessWindowStation");
        return _GetProcessWindowStation();
    }

    internal static bool GetUserObjectInformation(IntPtr hObj, int nIndex, byte[] pvInfo, uint nLength, out uint lpnLengthNeeded) {
        if (_GetUserObjectInformation == null) _GetUserObjectInformation = GetDelegate<GetUserObjectInformation_t>("user32.dll", "GetUserObjectInformationA");
        return _GetUserObjectInformation(hObj, nIndex, pvInfo, nLength, out lpnLengthNeeded);
    }

    internal static IntPtr OpenWindowStation(string lpszWinSta, bool fInherit, ACCESS_MASK dwDesiredAccess) {
        if (_OpenWindowStation == null) _OpenWindowStation = GetDelegate<OpenWindowStation_t>("user32.dll", "OpenWindowStationW");
        return _OpenWindowStation(lpszWinSta, fInherit, dwDesiredAccess);
    }

    internal static IntPtr OpenDesktop(string lpszDesktop, uint dwFlags, bool fInherit, ACCESS_MASK dwDesiredAccess) {
        if (_OpenDesktop == null) _OpenDesktop = GetDelegate<OpenDesktop_t>("user32.dll", "OpenDesktopA");
        return _OpenDesktop(lpszDesktop, dwFlags, fInherit, dwDesiredAccess);
    }

    internal static bool CloseWindowStation(IntPtr hWinsta) {
        if (_CloseWindowStation == null) _CloseWindowStation = GetDelegate<CloseWindowStation_t>("user32.dll", "CloseWindowStation");
        return _CloseWindowStation(hWinsta);
    }

    internal static bool CloseDesktop(IntPtr hDesktop) {
        if (_CloseDesktop == null) _CloseDesktop = GetDelegate<CloseDesktop_t>("user32.dll", "CloseDesktop");
        return _CloseDesktop(hDesktop);
    }

    internal static bool SetProcessWindowStation(IntPtr hWinSta) {
        if (_SetProcessWindowStation == null) _SetProcessWindowStation = GetDelegate<SetProcessWindowStation_t>("user32.dll", "SetProcessWindowStation");
        return _SetProcessWindowStation(hWinSta);
    }

    internal static bool GetUserObjectSecurity(IntPtr hObj, ref SECURITY_INFORMATION pSIRequested, IntPtr pSID, uint nLength, out uint lpnLengthNeeded) {
        if (_GetUserObjectSecurity == null) _GetUserObjectSecurity = GetDelegate<GetUserObjectSecurity_t>("user32.dll", "GetUserObjectSecurity");
        return _GetUserObjectSecurity(hObj, ref pSIRequested, pSID, nLength, out lpnLengthNeeded);
    }

    internal static bool SetUserObjectSecurity(IntPtr hObj, ref SECURITY_INFORMATION pSIRequested, IntPtr pSD) {
        if (_SetUserObjectSecurity == null) _SetUserObjectSecurity = GetDelegate<SetUserObjectSecurity_t>("user32.dll", "SetUserObjectSecurity");
        return _SetUserObjectSecurity(hObj, ref pSIRequested, pSD);
    }

    // --- userenv ---

    internal static bool CreateEnvironmentBlock(out IntPtr lpEnvironment, IntPtr hToken, bool bInherit) {
        if (_CreateEnvironmentBlock == null) _CreateEnvironmentBlock = GetDelegate<CreateEnvironmentBlock_t>("userenv.dll", "CreateEnvironmentBlock");
        return _CreateEnvironmentBlock(out lpEnvironment, hToken, bInherit);
    }

    internal static bool DestroyEnvironmentBlock(IntPtr lpEnvironment) {
        if (_DestroyEnvironmentBlock == null) _DestroyEnvironmentBlock = GetDelegate<DestroyEnvironmentBlock_t>("userenv.dll", "DestroyEnvironmentBlock");
        return _DestroyEnvironmentBlock(lpEnvironment);
    }

    internal static bool GetUserProfileDirectory(IntPtr hToken, StringBuilder path, ref int dwSize) {
        if (_GetUserProfileDirectory == null) _GetUserProfileDirectory = GetDelegate<GetUserProfileDirectory_t>("userenv.dll", "GetUserProfileDirectoryW");
        return _GetUserProfileDirectory(hToken, path, ref dwSize);
    }

    internal static bool LoadUserProfile(IntPtr hToken, ref PROFILEINFO lpProfileInfo) {
        if (_LoadUserProfile == null) _LoadUserProfile = GetDelegate<LoadUserProfile_t>("userenv.dll", "LoadUserProfileW");
        return _LoadUserProfile(hToken, ref lpProfileInfo);
    }

    internal static bool UnloadUserProfile(IntPtr hToken, IntPtr hProfile) {
        if (_UnloadUserProfile == null) _UnloadUserProfile = GetDelegate<UnloadUserProfile_t>("userenv.dll", "UnloadUserProfile");
        return _UnloadUserProfile(hToken, hProfile);
    }

    // --- ws2_32 ---

    internal static IntPtr WSASocket(AddressFamily addressFamily, SocketType socketType, ProtocolType protocolType, IntPtr protocolInfo, uint group, int flags) {
        if (_WSASocket == null) _WSASocket = GetDelegate<WSASocket_t>("ws2_32.dll", "WSASocketA");
        return _WSASocket(addressFamily, socketType, protocolType, protocolInfo, group, flags);
    }

    internal static int connect(IntPtr s, ref SOCKADDR_IN addr, int addrsize) {
        if (_connect == null) _connect = GetDelegate<connect_t>("ws2_32.dll", "connect");
        return _connect(s, ref addr, addrsize);
    }

    internal static ushort htons(ushort hostshort) {
        if (_htons == null) _htons = GetDelegate<htons_t>("ws2_32.dll", "htons");
        return _htons(hostshort);
    }

    internal static Int32 WSAGetLastError() {
        if (_WSAGetLastError == null) _WSAGetLastError = GetDelegate<WSAGetLastError_t>("ws2_32.dll", "WSAGetLastError");
        return _WSAGetLastError();
    }

    internal static Int32 WSAStartup(Int16 wVersionRequested, out WSAData wsaData) {
        if (_WSAStartup == null) _WSAStartup = GetDelegate<WSAStartup_t>("ws2_32.dll", "WSAStartup");
        return _WSAStartup(wVersionRequested, out wsaData);
    }

    internal static int closesocket(IntPtr s) {
        if (_closesocket == null) _closesocket = GetDelegate<closesocket_t>("ws2_32.dll", "closesocket");
        return _closesocket(s);
    }
}
